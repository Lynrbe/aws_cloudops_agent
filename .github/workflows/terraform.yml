name: CD - Terraform Apply

on:
  workflow_dispatch:
  push:
    branches:
      - feature/rag_pipeline
  # Uncomment below after testing to enable automatic CD trigger
  # workflow_run:
  #   workflows: ["CI - Build Lambda & Upload Artifacts"]
  #   types: [completed]
  #   branches:
  #     - main
  #     - feature/pipeline 

env:
  COMMIT_SHA: ${{ github.sha }} 

  ARTIFACT_BUCKET: ${{ secrets.ARTIFACT_BUCKET }} 

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # Config AWS
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
      env:
        NODE_TLS_REJECT_UNAUTHORIZED: '0' 

    # Install Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    # Configure system to bypass SSL for AWS
    - name: Configure system for proxy SSL bypass
      run: |
        # Disable SSL verification system-wide for this session
        export NODE_TLS_REJECT_UNAUTHORIZED=0

        # Create Terraform RC to configure provider behavior
        mkdir -p ~/.terraform.d
        cat > ~/.terraformrc << 'EOF'
        disable_checkpoint = true
        EOF

        # Configure git to not check SSL (for potential git operations)
        git config --global http.sslVerify false
      shell: bash

    # 1. Terraform Init (with retry for proxy timeout)
    - name: Terraform Init
      run: |
        # Unset CA bundle variables to disable SSL verification
        unset AWS_CA_BUNDLE
        unset SSL_CERT_FILE
        unset REQUESTS_CA_BUNDLE
        export AWS_SDK_LOAD_CONFIG=1

        # Using local backend, no S3 bucket config needed
        for i in 1 2 3; do
          if terraform -chdir=modules init; then
            exit 0
          fi
          echo "Terraform init failed, retrying... (attempt $i/3)"
          sleep 5
        done
        exit 1
      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
        AWS_EC2_METADATA_DISABLED: true
        TF_VAR_skip_ssl_validation: true
        TF_HTTP_SSL_VERIFY: "false"
        TF_IGNORE_REMOTE_VERSION: "true"

    # 1.5. Clean up conflicting resources
    - name: Remove existing resources that conflict with Terraform
      run: |
        echo "Cleaning up existing AWS resources..."

        # Remove S3 bucket notification first
        echo "Clearing S3 bucket notifications..."
        aws s3api put-bucket-notification-configuration \
          --bucket rag-agent-system-documents \
          --notification-configuration '{}' \
          --region ap-southeast-2 2>/dev/null || echo "S3 notification does not exist or already removed"

        # Remove Lambda permission
        echo "Removing Lambda permission..."
        aws lambda remove-permission \
          --function-name rag-agent-system-ingest \
          --statement-id AllowS3Invoke \
          --region ap-southeast-2 2>/dev/null || echo "Lambda permission does not exist or already removed"

        # Delete Lambda functions if they exist
        echo "Deleting Lambda function: rag-agent-system-ingest..."
        aws lambda delete-function \
          --function-name rag-agent-system-ingest \
          --region ap-southeast-2 2>/dev/null || echo "Lambda ingest does not exist or already removed"

        echo "Deleting Lambda function: rag-agent-system-retrieve..."
        aws lambda delete-function \
          --function-name rag-agent-system-retrieve \
          --region ap-southeast-2 2>/dev/null || echo "Lambda retrieve does not exist or already removed"

        # Wait a moment for deletions to propagate
        sleep 5
        echo "Cleanup complete"
      continue-on-error: true
      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'

    # 2. Terraform Plan
    - name: Terraform Plan
      run: |
        terraform -chdir=modules plan -out=tfplan \
          -var "ingest_artifact_key=ingest-${{ env.COMMIT_SHA }}.zip" \
          -var "retrieve_artifact_key=retrieve-${{ env.COMMIT_SHA }}.zip" \
          -var "artifact_bucket_name=${{ env.ARTIFACT_BUCKET }}"

      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
        AWS_EC2_METADATA_DISABLED: true
        TF_VAR_skip_ssl_validation: true
        TF_HTTP_SSL_VERIFY: "false"
        TF_IGNORE_REMOTE_VERSION: "true"

    # 3. Terraform Apply
    - name: Terraform Apply
      run: |
        # Unset CA bundle variables to disable SSL verification
        unset AWS_CA_BUNDLE
        unset SSL_CERT_FILE
        unset REQUESTS_CA_BUNDLE
        export AWS_SDK_LOAD_CONFIG=1
        terraform -chdir=modules apply -auto-approve tfplan
      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
        AWS_EC2_METADATA_DISABLED: true
        TF_VAR_skip_ssl_validation: true
        TF_HTTP_SSL_VERIFY: "false"
        TF_IGNORE_REMOTE_VERSION: "true"

    # 4. Update Knowledge Base ID in config
    - name: Update Knowledge Base ID in config
      if: success()
      run: |
        echo "Extracting Knowledge Base ID from Terraform output..."
        cd modules
        KB_ID=$(terraform output -raw knowledge_base_id)
        echo "Knowledge Base ID: $KB_ID"

        # Update the config file
        cd ..
        sed -i "s/id: \".*\"  # Will be set by Terraform or manually after KB deployment/id: \"$KB_ID\"  # Auto-updated by Terraform/" config/static-config.yaml

        echo "Knowledge Base ID updated in config/static-config.yaml"
      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'

    # 5. Backup Terraform state to S3 (using AWS CLI which can handle the proxy)
    - name: Backup Terraform State to S3
      if: success()
      run: |
        echo "Backing up Terraform state to S3..."
        aws s3 cp modules/terraform.tfstate s3://${{ secrets.TF_STATE_BUCKET }}/rag-agent/terraform.tfstate
        echo "State file backed up successfully to S3"
      env:
        AWS_REGION: ap-southeast-1
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
