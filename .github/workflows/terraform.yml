name: CD - Terraform Apply

on:
  workflow_dispatch:
  push:
    branches:
      - feature/rag_pipeline
  # Uncomment below after testing to enable automatic CD trigger
  # workflow_run:
  #   workflows: ["CI - Build Lambda & Upload Artifacts"]
  #   types: [completed]
  #   branches:
  #     - main
  #     - feature/pipeline 

env:
  COMMIT_SHA: ${{ github.sha }} 

  ARTIFACT_BUCKET: ${{ secrets.ARTIFACT_BUCKET }} 

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3

    # Config AWS
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ vars.AWS_REGION }}
      env:
        NODE_TLS_REJECT_UNAUTHORIZED: '0' 

    # Install Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    # Configure system to bypass SSL for AWS
    - name: Configure system for proxy SSL bypass
      run: |
        # Disable SSL verification system-wide for this session
        export NODE_TLS_REJECT_UNAUTHORIZED=0

        # Create Terraform RC to configure provider behavior
        mkdir -p ~/.terraform.d
        cat > ~/.terraformrc << 'EOF'
        disable_checkpoint = true
        EOF

        # Configure git to not check SSL (for potential git operations)
        git config --global http.sslVerify false
      shell: bash

    # 1. Terraform Init (with retry for proxy timeout)
    - name: Terraform Init
      run: |
        # Unset CA bundle variables to disable SSL verification
        unset AWS_CA_BUNDLE
        unset SSL_CERT_FILE
        unset REQUESTS_CA_BUNDLE
        export AWS_SDK_LOAD_CONFIG=1
        for i in 1 2 3; do
          if terraform -chdir=modules init -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" -backend-config="skip_credentials_validation=true" -backend-config="skip_metadata_api_check=true"; then
            exit 0
          fi
          echo "Terraform init failed, retrying... (attempt $i/3)"
          sleep 5
        done
        exit 1
      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
        AWS_EC2_METADATA_DISABLED: true
        TF_VAR_skip_ssl_validation: true
        TF_HTTP_SSL_VERIFY: "false"
        TF_IGNORE_REMOTE_VERSION: "true"

    # 1.5. Remove orphaned resources from state
    - name: Clean up orphaned resources
      run: |
        # Unset CA bundle variables
        unset AWS_CA_BUNDLE
        unset SSL_CERT_FILE
        unset REQUESTS_CA_BUNDLE
        export AWS_SDK_LOAD_CONFIG=1

        # Check if orphaned resources exist and remove them
        terraform -chdir=modules state list | grep -E "(aws_lambda_permission.allow_s3_invoke|aws_s3_bucket_notification.document_upload_trigger)" || true

        # Remove orphaned resources if they exist
        terraform -chdir=modules state rm aws_lambda_permission.allow_s3_invoke 2>/dev/null || true
        terraform -chdir=modules state rm aws_s3_bucket_notification.document_upload_trigger 2>/dev/null || true
      continue-on-error: true
      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
        AWS_EC2_METADATA_DISABLED: true
        TF_HTTP_SSL_VERIFY: "false"

    # 2. Terraform Plan
    - name: Terraform Plan
      run: |
        terraform -chdir=modules plan -out=tfplan \
          -var "ingest_artifact_key=ingest-${{ env.COMMIT_SHA }}.zip" \
          -var "retrieve_artifact_key=retrieve-${{ env.COMMIT_SHA }}.zip" \
          -var "artifact_bucket_name=${{ env.ARTIFACT_BUCKET }}"

      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
        AWS_EC2_METADATA_DISABLED: true
        TF_VAR_skip_ssl_validation: true
        TF_HTTP_SSL_VERIFY: "false"
        TF_IGNORE_REMOTE_VERSION: "true"

    # 3. Terraform Apply
    - name: Terraform Apply
      run: |
        # Unset CA bundle variables to disable SSL verification
        unset AWS_CA_BUNDLE
        unset SSL_CERT_FILE
        unset REQUESTS_CA_BUNDLE
        export AWS_SDK_LOAD_CONFIG=1
        terraform -chdir=modules apply -auto-approve tfplan
      env:
        AWS_REGION: ${{ vars.AWS_REGION }}
        NODE_TLS_REJECT_UNAUTHORIZED: '0'
        AWS_EC2_METADATA_DISABLED: true
        TF_VAR_skip_ssl_validation: true
        TF_HTTP_SSL_VERIFY: "false"
        TF_IGNORE_REMOTE_VERSION: "true"
