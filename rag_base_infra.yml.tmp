AWSTemplateFormatVersion: '2010-09-09'
Description: |
  CloudFormation template to deploy the core RAG infrastructure:
  S3 Bucket, OpenSearch Serverless Collection/Index, and Bedrock Knowledge Base.

# =================================================================
# PARAMETERS
# =================================================================
Parameters:
  ProjectName:
    Type: String
    Default: RAG-System
    Description: TÃªn cÆ¡ sá»Ÿ cho táº¥t cáº£ cÃ¡c tÃ i nguyÃªn vÃ  tÃªn Export.
  EmbeddingModelArn:
    Type: String
    Default: arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v1
    Description: ARN cá»§a Foundation Model dÃ¹ng Ä‘á»ƒ táº¡o Embeddings.
  VectorStoreIndexName:
    Type: String
    Default: rag-vector-index
    Description: TÃªn cá»§a Index (Báº£ng) trong OpenSearch.
  S3BucketNamePrefix:
    Type: String
    Default: rag-documents-store
    Description: Tiá»n tá»‘ tÃªn S3 Bucket.

# =================================================================
# RESOURCES
# =================================================================
Resources:

  # -----------------------------------------------------------------
  # 1. S3 BUCKET
  # -----------------------------------------------------------------
  RAGDocumentsS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${S3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}"
      VersioningConfiguration:
        Status: Enabled

  # -----------------------------------------------------------------
  # 2. OPENSEARCH SERVERLESS
  # -----------------------------------------------------------------
  OpenSearchCollection:
    Type: AWS::OpenSearchServerless::Collection
    Properties:
      Name: !Sub "${ProjectName}-RAG-Collection"
      Type: VECTORSEARCH

  # Data Access Policy (Cáº¥p quyá»n cho Knowledge Base Role)
  # Sá»­ dá»¥ng Fn::Sub vá»›i mapping Ä‘á»ƒ chÃ¨n ARN/Ref an toÃ n
  OpenSearchDataAccessPolicy:
    Type: AWS::OpenSearchServerless::AccessPolicy
    Properties:
      Name: !Sub "${ProjectName}-DataAccess-Policy"
      Type: data
      Policy: 
        !Sub
          - |
            [
              {
                "Rules": [
                  {
                    "ResourceType": "index",
                    "ResourceNames": ["${VectorStoreIndexName}"],
                    "Permission": [
                      "aoss:CreateIndex",
                      "aoss:DescribeIndex",
                      "aoss:UpdateIndex",
                      "aoss:DeleteIndex",
                      "aoss:ReadDocument",
                      "aoss:WriteDocument"
                    ]
                  },
                  {
                    "ResourceType": "collection",
                    "ResourceNames": ["${OpenSearchCollectionName}"],
                    "Permission": [
                      "aoss:DescribeCollection"
                    ]
                  }
                ],
                "Principal": ["${KBRoleArn}"]
              }
            ]
          - {
              VectorStoreIndexName: !Ref VectorStoreIndexName,
              OpenSearchCollectionName: !Ref OpenSearchCollection,
              KBRoleArn: !GetAtt KnowledgeBaseServiceRole.Arn
            }
    DependsOn: KnowledgeBaseServiceRole

  # -----------------------------------------------------------------
  # 3. IAM Role cho Knowledge Base (Assume Role: bedrock.amazonaws.com)
  # -----------------------------------------------------------------
  KnowledgeBaseServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: KnowledgeBasePermissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt RAGDocumentsS3Bucket.Arn
                  - !Sub "${RAGDocumentsS3Bucket.Arn}/*"
              - Effect: Allow
                Action:
                  - "aoss:APIAccessAll"
                Resource: !GetAtt OpenSearchCollection.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*

  # -----------------------------------------------------------------
  # 4. BEDROCK KNOWLEDGE BASE & DATA SOURCE
  # -----------------------------------------------------------------
  RAGKnowledgeBase:
    Type: AWS::Bedrock::KnowledgeBase
    Properties:
      Name: !Sub "${ProjectName}-KB-${AWS::StackName}"
      RoleArn: !GetAtt KnowledgeBaseServiceRole.Arn
      KnowledgeBaseConfiguration:
        Type: AMAZON_KNOWLEDGE_BASE
        FoundationModelArn: !Ref EmbeddingModelArn
      StorageConfiguration:
        Type: OPENSEARCH_SERVERLESS_VEC
        VectorKnowledgeBaseConfiguration:
          EmbeddingModelArn: !Ref EmbeddingModelArn
        OpenSearchServerlessConfiguration:
          CollectionArn: !GetAtt OpenSearchCollection.Arn
          VectorField: "bedrock-vector"
          TextField: "text"
          IndexName: !Ref VectorStoreIndexName
    DependsOn: OpenSearchDataAccessPolicy

  RAGKnowledgeBaseDataSource:
    Type: AWS::Bedrock::DataSource
    Properties:
      Name: "RAG-Document-Data-Source"
      KnowledgeBaseId: !Ref RAGKnowledgeBase
      DataSourceConfiguration:
        Type: S3
        S3Configuration:
          BucketArn: !GetAtt RAGDocumentsS3Bucket.Arn
          InclusionPrefixes:
            - rag_documents/

# =================================================================
# OUTPUTS (Äá»ƒ Stack khÃ¡c tham chiáº¿u chÃ©o)
# =================================================================
Outputs:
  RAGDocumentsS3BucketName:
    Value: !Ref RAGDocumentsS3Bucket
    Export:
      Name: !Sub "${ProjectName}-RAGDocumentsS3BucketName"

  KnowledgeBaseId:
    Value: !Ref RAGKnowledgeBase
    Export:
      Name: !Sub "${ProjectName}-KnowledgeBaseId"

  KnowledgeBaseDataSourceId:
    Value: !Ref RAGKnowledgeBaseDataSource
    Export:
      Name: !Sub "${ProjectName}-KnowledgeBaseDataSourceId"

  OpenSearchCollectionArn:
    Value: !GetAtt OpenSearchCollection.Arn
    Export:
      Name: !Sub "${ProjectName}-OpenSearchCollectionArn"
